<div [@routerTransition]>
    <div class="m-subheader ">
        <div class="d-flex align-items-center">
            <div class="mr-auto col-xs-6">
                <h3 class="m-subheader__title m-subheader__title--separator">
                    <span>{{l("Phiếu gọi hàng")}}</span>
                </h3>
                <span *ngIf="phieugoihang.id" class="m-section__sub">{{l("Cập nhật phiếu gọi hàng")}}</span>
                <span *ngIf="!phieugoihang.id" class="m-section__sub">{{l("Tạo phiếu gọi hàng")}}</span>
            </div>
        </div>
    </div>
    <div class="m-content">
        <div class="m-portlet m-portlet--mobile">
            <div class="m-portlet__body">
                <div class="row align-items-center">
                    <!--<Primeng-TurboTable-Start>-->
                    <div class="primeng-datatable-container">
                        <form ngNativeValidate #editForm="ngForm" (ngSubmit)="save()">
                            <div class="modal-header">
                                <h4 class="modal-title">
                                    <span *ngIf="phieugoihang.id">Cập nhật phiếu gọi hàng: {{phieugoihang.planCode}}</span>
                                    <span *ngIf="!phieugoihang.id">Tạo mới phiếu gọi hàng</span>
                                </h4>
                                <button type="button" class="close" (click)="close()" [attr.aria-label]="l('Close')">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body row">
                                <div class="modal fade" id="myModalDonViThau" role="dialog">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-body">
                                                <div class="form-group col-sm-11" style="margin-left: 3%;">
                                                    <ngForm #nhacungcapForm="ngForm" autocomplete="off">
                                                        <div class="m-form m-form--label-align-right" id="TextsFilterForm">
                                                            <div class="row align-items-center m--margin-bottom-10">
                                                                <div class="col-sm-12">
                                                                    <div class="input-group">
                                                                        <input [(ngModel)]="nhacungcapName" name="nhacungcapName" autoFocus class="form-control"
                                                                               placeholder="Nhập tên đơn vị" type="text">
                                                                        <span class="input-group-btn">
                                                                            <button (click)="applyFiltersNhaCungCap()" class="btn btn-primary" type="button">
                                                                                <i class="icon-refresh"></i>
                                                                                {{l("Refresh")}}
                                                                            </button>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </ngForm>

                                                    <div class="row align-items-center">
                                                        <!--<Primeng-TurboTable-Start>-->
                                                        <div class="primeng-datatable-container" [busyIf]="primengTableHelper.isLoading">
                                                            <p-table #dataTable (onLazyLoad)="getNhaCungCaps($event)" [value]="primengTableHelper.records"
                                                                     rows="{{primengTableHelper.defaultRecordsCountPerPage}}" [paginator]="false" [lazy]="true"
                                                                     [responsive]="primengTableHelper.isResponsive">
                                                                <ng-template pTemplate="header">
                                                                    <tr>
                                                                        <th pSortableColumn="name">
                                                                            Mã đơn vị
                                                                            <p-sortIcon field="name"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="address">
                                                                            Tên đơn vị
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Địa chỉ
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Điện thoại
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        <th pSortableColumn="info">
                                                                            Email
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Action
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                    </tr>
                                                                </ng-template>
                                                                <ng-template pTemplate="body" let-record="$implicit">
                                                                    <tr>
                                                                        <td>
                                                                            <span class="ui-column-title">Mã đơn vị</span>
                                                                            <span title="{{record.supplierCode}}">{{truncateString(record.supplierCode)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Tên đơn vị</span>
                                                                            <span title="{{record.supplierName}}">{{truncateString(record.supplierName)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Địa chỉ</span>
                                                                            <span title="{{record.address}}">{{truncateString(record.address)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Số điện thoại</span>
                                                                            <span title="{{record.phoneNumber}}">{{truncateString(record.phoneNumber)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Email</span>
                                                                            <span title="{{record.email}}">{{truncateString(record.email)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="bg-success" *ngIf="record.supplierCode" (click)="onSelectNhaCungCap(record)" style="border-radius: 5px 5px; cursor:pointer;"><span class="fa fa-plus"></span></button>
                                                                        </td>
                                                                    </tr>
                                                                </ng-template>
                                                            </p-table>
                                                            <div class="primeng-no-data" *ngIf="primengTableHelper.totalRecordsCount == 0">
                                                                {{l('NoData')}}
                                                            </div>
                                                            <div class="primeng-paging-container">
                                                                <p-paginator rows="{{primengTableHelper.defaultRecordsCountPerPage}}" #paginator
                                                                             (onPageChange)="getNhaCungCaps($event)"
                                                                             [totalRecords]="primengTableHelper.totalRecordsCount"
                                                                             [rowsPerPageOptions]="primengTableHelper.predefinedRecordsCountPerPage">
                                                                </p-paginator>
                                                                <span class="total-records-count">
                                                                    {{l('TotalRecordsCount', primengTableHelper.totalRecordsCount)}}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <!--<Primeng-TurboTable-End>-->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal fade" id="myModalHopDong" role="dialog">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-body">
                                                <div class="form-group col-sm-11" style="margin-left: 3%;">
                                                    <ngForm #nhacungcapForm="ngForm" autocomplete="off">
                                                        <div class="m-form m-form--label-align-right" id="TextsFilterForm">
                                                            <div class="row align-items-center m--margin-bottom-10">
                                                                <div class="col-sm-12">
                                                                    <div class="input-group">
                                                                        <input [(ngModel)]="contractName" name="contractName" autoFocus class="form-control"
                                                                               placeholder="Nhập tên hợp đồng" type="text">
                                                                        <span class="input-group-btn">
                                                                            <button (click)="applyFiltersContract()" class="btn btn-primary" type="button">
                                                                                <i class="icon-refresh"></i>
                                                                                {{l("Refresh")}}
                                                                            </button>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </ngForm>

                                                    <div class="row align-items-center">
                                                        <!--<Primeng-TurboTable-Start>-->
                                                        <div class="primeng-datatable-container" [busyIf]="primengTableHelper.isLoading">
                                                            <p-table #dataTable (onLazyLoad)="getContracts($event)" [value]="primengTableHelper.records"
                                                                     rows="{{primengTableHelper.defaultRecordsCountPerPage}}" [paginator]="false" [lazy]="true"
                                                                     [responsive]="primengTableHelper.isResponsive">
                                                                <ng-template pTemplate="header">
                                                                    <tr>
                                                                        <th pSortableColumn="name">
                                                                            Số HD
                                                                            <p-sortIcon field="name"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="address">
                                                                            Tên hợp đồng
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Mã gói thầu
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Ngày HD
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        <th pSortableColumn="info">
                                                                            Đơn vị
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                        <th pSortableColumn="info">
                                                                            Action
                                                                            <p-sortIcon field="info"></p-sortIcon>
                                                                        </th>
                                                                    </tr>
                                                                </ng-template>
                                                                <ng-template pTemplate="body" let-record="$implicit">
                                                                    <tr>
                                                                        <td>
                                                                            <span class="ui-column-title">Số HD</span>
                                                                            <span title="{{record.contractCode}}">{{truncateString(record.contractCode)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Tên hợp đồng</span>
                                                                            <span title="{{record.contractName}}">{{truncateString(record.contractName)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Mã gói thầu</span>
                                                                            <span title="{{record.bidCode}}">{{truncateString(record.bidCode)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Ngày HD</span>
                                                                            <span title="{{record.contractDayCreate}}">{{truncateString(record.contractDayCreate)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="ui-column-title">Đơn vị</span>
                                                                            <span title="{{record.unitAcceptedCode}}">{{truncateString(record.unitAcceptedCode)}}</span>
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="bg-success" *ngIf="record.contractCode" (click)="onSelectContract(record)" style="border-radius: 5px 5px; cursor:pointer;"><span class="fa fa-plus"></span></button>
                                                                        </td>
                                                                    </tr>
                                                                </ng-template>
                                                            </p-table>
                                                            <div class="primeng-no-data" *ngIf="primengTableHelper.totalRecordsCount == 0">
                                                                {{l('NoData')}}
                                                            </div>
                                                            <div class="primeng-paging-container">
                                                                <p-paginator rows="{{primengTableHelper.defaultRecordsCountPerPage}}" #paginator
                                                                             (onPageChange)="getContracts($event)"
                                                                             [totalRecords]="primengTableHelper.totalRecordsCount"
                                                                             [rowsPerPageOptions]="primengTableHelper.predefinedRecordsCountPerPage">
                                                                </p-paginator>
                                                                <span class="total-records-count">
                                                                    {{l('TotalRecordsCount', primengTableHelper.totalRecordsCount)}}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <!--<Primeng-TurboTable-End>-->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                                <div class="form-group col-sm-4">
                                    <label>Số PO *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="soPO"
                                           [(ngModel)]="phieugoihang.poCode" required maxlength="64">
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Ngày gọi hàng *</label>
                                    <input #addressInput="ngModel" class="form-control" type="date" name="ngayGoiHang"
                                           [(ngModel)]="phieugoihang.poDate" required maxlength="64">
                                    <div style="color: red;" role="alert" *ngIf="editForm.controls.ngayGoiHang.errors?.required &&
                         editForm.controls.ngayGoiHang.touched">Field is required</div>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tên đơn hàng *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="tenDonHang"
                                           [(ngModel)]="phieugoihang.poName" required maxlength="64">
                                </div>

                                <div class="form-group col-sm-4">
                                    <label>Số tờ trình *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="soToTrinh"
                                           [(ngModel)]="phieugoihang.reportNumber" required maxlength="64">
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Ngày nhận tờ trình *</label>
                                    <input #addressInput="ngModel" class="form-control" type="date" name="ngayNhanToTrinh"
                                           [(ngModel)]="phieugoihang.reportReceiveDate" required maxlength="64">
                                    <div style="color: red;" role="alert" *ngIf="editForm.controls.ngayNhanToTrinh.errors?.required &&
                         editForm.controls.ngayNhanToTrinh.touched">Field is required</div> 
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Ngày duyệt tờ trình *</label>
                                    <input #addressInput="ngModel" class="form-control" type="date" name="ngayDuyetToTrinh"
                                           [(ngModel)]="phieugoihang.reportConfirmDate" required maxlength="64">
                                    <div style="color: red;" role="alert" *ngIf="editForm.controls.ngayDuyetToTrinh.errors?.required &&
                         editForm.controls.ngayDuyetToTrinh.touched">Field is required</div>
                                </div>

                                <div class="form-group col-sm-4">
                                    <label>Số hợp đồng *</label>
                                    <p class="input-group">
                                        <input #addressInput="ngModel" class="form-control" type="text" name="soHopDong"
                                               [(ngModel)]="phieugoihang.contractCode" required maxlength="64">
                                        <span class="input-group-append">
                                            <button type="button" class="btn btn-info input-group-text" data-toggle="modal" data-target="#myModalHopDong"><span class="fa fa-folder-open"></span></button>
                                        </span>
                                    </p>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tổng giá trị hợp đồng *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="tongGiaTriHopDong"
                                           [(ngModel)]="phieugoihang.totalPriceContract" required maxlength="64" disabled>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tổng giá trị đã thực hiện *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="tongGiaTriThucHien"
                                           [(ngModel)]="phieugoihang.totalPriceContractPayment" required maxlength="64" disabled>
                                </div>
                                <div class="form-group col-sm-12">
                                    <label>Nội dung hợp đồng *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="noiDungHopDong"
                                           [(ngModel)]="phieugoihang.contractContent" required maxlength="64" disabled style="height: 150px;">
                                </div>

                                <div class="form-group col-sm-12 m--margin-left-10" style="margin-top: 2%; margin-bottom: 2%;">
                                    <label>Chi tiết hàng hóa *</label>
                                    <ngForm #hanghoahopdongForm="ngForm" autocomplete="off">
                                        <div class="m-form m-form--label-align-right" id="TextsFilterForm">
                                            <div class="row align-items-center m--margin-bottom-10">
                                                <div class="input-group" style="width: 98%;">
                                                    <input [(ngModel)]="hopdongthauCode" name="hopdongthauCode" autoFocus class="form-control"
                                                            placeholder="Nhập mã hợp đồng" type="text">
                                                    <span class="input-group-btn">
                                                        <button (click)="applyFiltersHopDongHangHoa()" class="btn btn-primary" type="button">
                                                            <i class="icon-refresh"></i>
                                                            {{l("Refresh")}}
                                                        </button>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </ngForm>

                                    <div class="row align-items-center" style="width: 100%;">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Tên hàng hóa</th>
                                                    <th>Chủng loại</th>
                                                    <th>Đơn giá</th>
                                                    <th>Tên nhà cung cấp</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let listhopdonghanghoa of listHopDongHangHoa">
                                                    <td>{{listhopdonghanghoa.goodsName}}</td>
                                                    <td>{{listhopdonghanghoa.type}}</td>
                                                    <td>{{listhopdonghanghoa.price}}</td>
                                                    <td>{{listhopdonghanghoa.supplierName}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="form-group col-sm-12 m--margin-left-10" style="margin-bottom: 2%;">
                                    <ngForm #paymentContractForm="ngForm" autocomplete="off">
                                        <div class="m-form m-form--label-align-right" id="TextsFilterForm">
                                            <div class="row align-items-center m--margin-bottom-10">
                                                <div class="col-sm-11">
                                                    <label style="font-weight: 600;">Lịch thanh toán *</label>
                                                </div>
                                                <div class="col-sm-1">
                                                    <div class="input-group">
                                                        <button (click)="applyFiltersContractPayment()" class="btn btn-primary" type="button">
                                                            <i class="icon-refresh"></i>
                                                            {{l("Refresh")}}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </ngForm>
                                    <div class="row align-items-center" style="width: 100%;">
                                        <div class="primeng-datatable-container" [busyIf]="primengTableHelper.isLoading">
                                            <p-table #dataTable (onLazyLoad)="getContractPayments($event)" [value]="primengTableHelper.records"
                                                     rows="{{primengTableHelper.defaultRecordsCountPerPage}}" [paginator]="false" [lazy]="true"
                                                     [responsive]="primengTableHelper.isResponsive">
                                                <ng-template pTemplate="header">
                                                    <tr>
                                                        <th pSortableColumn="name">
                                                            Đợt
                                                            <p-sortIcon field="name"></p-sortIcon>
                                                        </th>
                                                        <th pSortableColumn="address">
                                                            Ngày dự kiến
                                                        </th>
                                                        <th pSortableColumn="info">
                                                            Phần trăm
                                                            <p-sortIcon field="info"></p-sortIcon>
                                                        </th>
                                                        <th pSortableColumn="info">
                                                            Số tiền
                                                            <p-sortIcon field="info"></p-sortIcon>
                                                        </th>
                                                        <th pSortableColumn="info">
                                                            Diễn giải
                                                            <p-sortIcon field="info"></p-sortIcon>
                                                        </th>
                                                    </tr>
                                                </ng-template>
                                                <ng-template pTemplate="body" let-record="$implicit">
                                                    <tr>
                                                        <td>
                                                            <span class="ui-column-title">Đợt</span>
                                                            <span title="{{record.timePayment}}">{{truncateString(record.timePayment)}}</span>
                                                        </td>
                                                        <td>
                                                            <span class="ui-column-title">Ngày dự kiến</span>
                                                            <span title="{{record.paymentDate}}">{{truncateString(record.paymentDate)}}</span>
                                                        </td>
                                                        <td>
                                                            <span class="ui-column-title">Phần trăm</span>
                                                            <span title="{{record.ratio}}">{{truncateString(record.ratio)}}</span>
                                                        </td>
                                                        <td>
                                                            <span class="ui-column-title">Số tiền</span>
                                                            <span title="{{record.money}}">{{truncateString(record.money)}}</span>
                                                        </td>
                                                        <td>
                                                            <span class="ui-column-title">Diễn giải</span>
                                                            <span title="{{record.content}}">{{truncateString(record.content)}}</span>
                                                        </td>
                                                    </tr>
                                                </ng-template>
                                            </p-table>
                                            <div class="primeng-no-data" *ngIf="primengTableHelper.totalRecordsCount == 0">
                                                {{l('NoData')}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group col-sm-4">
                                    <label>Mã nhà cung cấp *</label>
                                    <p class="input-group">
                                        <input #addressInput="ngModel" class="form-control" type="text" name="maNhaCungCap"
                                               [(ngModel)]="phieugoihang.unitCode" required maxlength="64">
                                        <span class="input-group-append">
                                            <button type="button" class="btn btn-info input-group-text" data-toggle="modal" data-target="#myModalDonViThau"><span class="fa fa-folder-open"></span></button>
                                        </span>
                                    </p>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tên nhà cung cấp *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="tenNhaCungCap"
                                           [(ngModel)]="phieugoihang.unitName" required maxlength="64">
                                </div>

                                <div class="form-group col-sm-4">
                                    <label>Địa chỉ *</label>
                                    <input #addressInput="ngModel" class="form-control" type="text" name="diaChi"
                                           [(ngModel)]="phieugoihang.unitAddress" required maxlength="64">
                                </div>

                                <div class="form-group col-sm-4">
                                    <label>Quá trình thanh toán *</label>
                                    <select #quatrinhthanhtoanCombobox name="quaTrinhThanhToan" class="form-control" [(ngModel)]="phieugoihang.paymentProcess"
                                            [attr.data-live-search]="true" jq-plugin="selectpicker" required>
                                        <option selected disabled value="">---Quá Trình Thanh Toán---</option>
                                        <option [value]="">Thanh toán trực tiếp</option>
                                        <option [value]="">Thanh toán bằng thẻ ngân hàng</option>
                                        <option [value]="">Thanh toán bằng thẻ giao dịch quốc tế (VISA/MASTER CARD)</option>
                                    </select>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tiến độ giao hàng *</label>
                                    <select #tiendogiaohangCombobox name="tienDoGiaoHang" class="form-control" [(ngModel)]="phieugoihang.shippingProcess"
                                            [attr.data-live-search]="true" jq-plugin="selectpicker" required>
                                        <option selected disabled value="">---Tiến Độ Giao Hàng---</option>
                                        <option [value]="">Đang giao hàng</option>
                                        <option [value]="">Đang chờ</option>
                                        <option [value]="">Đã hủy hàng</option>
                                    </select>
                                </div>
                                <div class="form-group col-sm-4">
                                    <label>Tình trạng hóa đơn *</label>
                                    <select #tinhtranghoadonCombobox name="tinhTrangHoaDon" class="form-control" [(ngModel)]="phieugoihang.billStatus"
                                            [attr.data-live-search]="true" jq-plugin="selectpicker" required>
                                        <option selected disabled value="">---Tình Trạng Hóa Đơn---</option>
                                        <option [value]="">Đang thanh toán</option>
                                        <option [value]="">Chưa thanh toán</option>
                                        <option [value]="">Đã hủy hóa đơn</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <a routerLink="/app/gwebsite/phieugoihang">
                                    <button [disabled]="saving" type="button" class="btn btn-default"
                                            (click)="close()">
                                        {{l("Cancel")}}
                                    </button>
                                </a>
                                <button type="submit" class="btn btn-primary" [buttonBusy]="saving"
                                        [busyText]="l('SavingWithThreeDot')">
                                    <i class="fa fa-save"></i>
                                    <span>{{l("Save")}}</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    <!--<Primeng-TurboTable-End>-->
                </div>
            </div>
        </div>
    </div>
</div>
